<!doctype html>
<html>
</head>
<title>Hello, Snaps!</title>
<link rel="icon" type="image/svg" href="./images/icon.svg" />
</head>

<body>
  <h1>Aleo Snap</h1>
  <h2>Aleo wallet implementation using MetaMask Snaps</h2>
  <!-- <details>
    <summary>Instructions</summary>
    <ul>
      <li>First, click "Connect". Then, try out the other buttons!</li>
      <li>Please note that:</li>
      <ul>
        <li>
          The <code>snap.manifest.json</code> and <code>package.json</code> must be located in located in the server
          root directory..
        </li>
        <li>
          The Snap bundle must be hosted at the location specified by the <code>location</code> field of
          <code>snap.manifest.json</code>.
        </li>
      </ul>
    </ul>
  </details> -->
  <br />

  <p>First, let's connect to MetaMask and install the snap.</p>
  <button class="connect">Connect</button>
  <br />
  <br />

  <div id="accountButtonDiv" style="display: none;">
    <p>Now, let's create an Aleo-compatible wallet inside the snap.</p>
    <button class="getAccount">Get Account</button>
    <br />
  </div>

  <div id="account" style="display: none;">
    <h3>Account</h3>
    <ul>
      <li>
        Address: <code><span id="accountAddress"></span></code>
      </li>
      <li>
        View Key: <code><span id="viewKey"></span></code>
      </li>
      <li>
        Private Key: <code><span id="privateKey"></span></code>
      </li>
    </ul>
  </div>
  <br />

  <div id="sendTxBtnDiv" style="display: none;">
    <p>Finally, we send a transaction using our wallet.</p>
    <button class="sendTx">Send Transaction</button>
  </div>
  <br />
</body>

<script>
  const snapId = `local:${window.location.href}`;

  const connectButton = document.querySelector('button.connect')
  const getAccountButton = document.querySelector('button.getAccount')
  const sendTxButton = document.querySelector('button.sendTx')

  connectButton.addEventListener('click', connect)
  getAccountButton.addEventListener('click', getAccount)
  sendTxButton.addEventListener('click', sendTransaction)

  async function connect() {
    try {
      await ethereum.request({
        method: 'wallet_enable',
        params: [{
          wallet_snap: { [snapId]: {} },
        }]
      })

      document.querySelector('#accountButtonDiv').style.display = 'block'
    } catch (error) {
      // The `wallet_enable` call will throw if the requested permissions are
      // rejected.
      if (error.code === 4001) {
        console.error('The user rejected the request.');
        alert('The user rejected the request.');
      } else {
        console.error(error)
        alert('Error: ' + error.message || error)
      }
    }
  }

  async function getAccount() {
    try {
      const account = await ethereum.request({
        method: 'wallet_invokeSnap',
        params: [snapId, {
          method: 'aleo_get_account',
          params: ['fake-seed'],
        }]
      })

      console.log(JSON.stringify(account, null, 2))
      document.querySelector('#accountAddress').innerText = account.address
      document.querySelector('#viewKey').innerText = account.view_key
      document.querySelector('#privateKey').innerText = 'Never leaves MetaMask!'
      document.querySelector('#account').style.display = 'block'
      document.querySelector('#sendTxBtnDiv').style.display = 'block'
    } catch (error) {
      console.error(error)
      alert('Error: ' + error.message || error)
    }
  }

  async function sendTransaction() {
    try {
      const response = await ethereum.request({
        method: 'wallet_invokeSnap',
        params: [snapId, {
          method: 'aleo_send_transaction',
          params: ['fake-seed', 'fake-tx'],
        }]
      })
      console.log({ response })
    } catch (err) {
      console.error(err)
      alert('Error: ' + err.message || err)
    }
  }
</script>

</html>